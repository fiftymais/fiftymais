<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Fifty+</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --red: #C41E1E;
  --red-dark: #A01818;
  --red-light: #FFF0F0;
  --bg: #F2F2F7;
  --surface: #FFFFFF;
  --surface2: #F8F8F8;
  --border: #E5E5EA;
  --text: #1C1C1E;
  --text2: #3A3A3C;
  --text3: #8E8E93;
  --radius: 12px;
  --tab-h: 60px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  font-size: 15px; -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
}

/* LOGIN */
#loginScreen {
  min-height: 100dvh; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(160deg,#111 0%,#2A0808 100%);
  padding: calc(24px + var(--safe-top)) 20px calc(24px + var(--safe-bottom));
}
.login-box { background:#fff; border-radius:20px; padding:36px 24px; width:100%; max-width:400px; box-shadow:0 24px 80px rgba(0,0,0,.5); }
.login-logo { font-size:30px; font-weight:800; color:var(--red); text-align:center; margin-bottom:4px; letter-spacing:-1px; }
.login-sub { text-align:center; font-size:13px; color:var(--text3); margin-bottom:28px; }
.login-label { font-size:12px; font-weight:700; color:var(--text2); display:block; margin-bottom:5px; margin-top:14px; text-transform:uppercase; letter-spacing:.5px; }
.login-input { width:100%; padding:13px 15px; border:1.5px solid var(--border); border-radius:10px; font-family:'Inter',sans-serif; font-size:16px; outline:none; background:var(--surface2); color:var(--text); transition:border-color .15s; }
.login-input:focus { border-color:var(--red); background:#fff; }
.login-btn { width:100%; padding:15px; background:var(--red); color:#fff; border:none; border-radius:10px; font-family:'Inter',sans-serif; font-size:15px; font-weight:700; cursor:pointer; margin-top:20px; min-height:52px; letter-spacing:.3px; }
.login-btn:active { background:var(--red-dark); transform:scale(.98); }
.login-btn:disabled { opacity:.5; }
.login-err { background:#FFF0F0; border:1px solid #FCA5A5; color:var(--red); font-size:13px; padding:11px 13px; border-radius:9px; margin-top:12px; display:none; line-height:1.4; }
.login-link { text-align:center; margin-top:14px; font-size:13px; color:var(--text3); padding:8px; cursor:pointer; }
.login-link a { color:var(--red); font-weight:600; text-decoration:none; }

/* APP */
#appScreen { display:none; min-height:100dvh; }
.topbar { background:#fff; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 16px; height:calc(52px + var(--safe-top)); padding-top:var(--safe-top); position:sticky; top:0; z-index:100; }
.topbar-logo { font-size:20px; font-weight:800; color:var(--red); letter-spacing:-0.5px; }
.topbar-right { display:flex; align-items:center; gap:8px; }
.nav-avatar { width:32px; height:32px; border-radius:50%; background:var(--red); color:#fff; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; }
.btn-sair { font-size:13px; color:var(--text3); cursor:pointer; padding:7px 11px; border-radius:8px; border:1px solid var(--border); background:none; font-family:'Inter',sans-serif; }
.btn-sair:active { background:var(--bg); }

.content { max-width:640px; margin:0 auto; padding:14px 13px calc(var(--tab-h) + var(--safe-bottom) + 14px); }

/* TABBAR */
.tabbar { position:fixed; bottom:0; left:0; right:0; background:rgba(255,255,255,.97); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-top:1px solid var(--border); display:flex; height:calc(var(--tab-h) + var(--safe-bottom)); padding-bottom:var(--safe-bottom); z-index:100; }
.tab-btn { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; border:none; background:none; cursor:pointer; font-family:'Inter',sans-serif; color:var(--text3); padding:8px 4px 4px; }
.tab-btn.active { color:var(--red); }
.tab-icon { font-size:20px; line-height:1; }
.tab-label { font-size:10px; font-weight:600; letter-spacing:.2px; }

/* PAGES */
.page { display:none; }
.page.active { display:block; }

/* CARDS */
.card { background:#fff; border-radius:var(--radius); padding:16px; margin-bottom:11px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
.card-head { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--red); margin-bottom:14px; }

/* FORM */
.field { margin-bottom:13px; }
.field:last-child { margin-bottom:0; }
label { display:block; font-size:12px; font-weight:700; color:var(--text2); margin-bottom:5px; text-transform:uppercase; letter-spacing:.4px; }
input[type=text],input[type=email],input[type=tel],input[type=number],input[type=date],input[type=password],select,textarea {
  width:100%; padding:12px 13px; border:1.5px solid var(--border); border-radius:9px;
  font-family:'Inter',sans-serif; font-size:15px; color:var(--text); background:var(--surface2);
  outline:none; -webkit-appearance:none; min-height:48px; transition:border-color .15s;
}
input:focus,select:focus,textarea:focus { border-color:var(--red); background:#fff; box-shadow:0 0 0 3px rgba(196,30,30,.07); }
input::placeholder,textarea::placeholder { color:var(--text3); font-weight:400; }
textarea { min-height:auto; resize:none; line-height:1.5; }
.g2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* BUTTONS */
.btn { display:flex; align-items:center; justify-content:center; gap:6px; width:100%; padding:15px; border-radius:10px; font-family:'Inter',sans-serif; font-size:15px; font-weight:700; cursor:pointer; border:none; min-height:52px; letter-spacing:.2px; -webkit-appearance:none; transition:all .15s; }
.btn:disabled { opacity:.5; }
.btn:active:not(:disabled) { transform:scale(.97); }
.btn-primary { background:var(--red); color:#fff; }
.btn-primary:active:not(:disabled) { background:var(--red-dark); }
.btn-outline { background:#fff; color:var(--text2); border:1.5px solid var(--border); }
.btn-outline:active { background:var(--bg); }
.btn-dark { background:#1C1C1E; color:#fff; }
.btn-dark:active { background:#000; }
.btn-wa { background:#25D366; color:#fff; }
.btn-wa:active { background:#1DBB5B; }
.btn-row { display:flex; gap:9px; margin-top:8px; }
.btn-row .btn { flex:1; }

/* STEPS */
.steps-bar { display:flex; align-items:center; background:#fff; border-radius:var(--radius); padding:11px 12px; margin-bottom:13px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; box-shadow:0 1px 3px rgba(0,0,0,.06); }
.steps-bar::-webkit-scrollbar { display:none; }
.step-dot { display:flex; align-items:center; gap:5px; font-size:11px; font-weight:600; color:var(--text3); white-space:nowrap; cursor:pointer; padding:3px; }
.step-dot.active { color:var(--red); }
.step-dot.done { color:#248A3D; }
.sd { width:22px; height:22px; border-radius:50%; background:var(--border); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; flex-shrink:0; color:var(--text3); }
.step-dot.active .sd { background:var(--red); color:#fff; }
.step-dot.done .sd { background:#248A3D; color:#fff; }
.step-line { flex:1; min-width:12px; height:1.5px; background:var(--border); flex-shrink:0; }

/* AMBIENTES */
.amb-item { background:var(--surface2); border:1.5px solid var(--border); border-radius:10px; padding:14px; margin-bottom:10px; }
.amb-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:13px; }
.amb-num { font-size:12px; font-weight:700; color:var(--red); text-transform:uppercase; letter-spacing:.5px; }
.btn-rm { width:32px; height:32px; border-radius:7px; border:1px solid #FCA5A5; background:#FFF0F0; color:#EF4444; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; line-height:1; }

.btn-add-amb { display:flex; align-items:center; gap:7px; justify-content:center; width:100%; padding:13px; border:2px dashed var(--border); border-radius:9px; background:none; font-family:'Inter',sans-serif; font-size:14px; font-weight:600; color:var(--text3); cursor:pointer; min-height:50px; margin-top:4px; }
.btn-add-amb:active { border-color:var(--red); color:var(--red); }

/* PROPOSTAS */
.prop-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:13px; }
.prop-header h1 { font-size:22px; font-weight:800; }
.btn-nova { background:var(--red); color:#fff; border:none; border-radius:9px; padding:9px 18px; font-family:'Inter',sans-serif; font-size:14px; font-weight:700; cursor:pointer; min-height:42px; }
.btn-nova:active { background:var(--red-dark); transform:scale(.97); }
.search-row { display:flex; flex-direction:column; gap:7px; margin-bottom:13px; }
@media(min-width:480px){ .search-row { flex-direction:row; } }
.prop-card { background:#fff; border-radius:var(--radius); padding:15px; margin-bottom:9px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
.pc-top { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
.pc-num { font-size:11px; color:var(--text3); margin-bottom:2px; font-weight:500; }
.pc-cliente { font-size:16px; font-weight:700; }
.pc-tipo { font-size:13px; color:var(--text2); margin-top:2px; }
.pc-total { font-size:17px; font-weight:800; color:var(--red); text-align:right; flex-shrink:0; }
.status-badge { font-size:10px; font-weight:700; padding:3px 8px; border-radius:20px; display:inline-block; margin-top:5px; text-transform:uppercase; letter-spacing:.3px; }
.status-ativa { background:#EFF6FF; color:#1D4ED8; }
.status-enviada { background:#F0FFF4; color:#15803D; }
.status-fechada { background:#F3F4F6; color:#6B7280; }
.pc-actions { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:5px; margin-top:11px; }
.pc-btn { padding:9px 4px; border-radius:7px; font-size:11px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:var(--surface2); font-family:'Inter',sans-serif; color:var(--text2); min-height:40px; text-align:center; }
.pc-btn:active { background:var(--bg); transform:scale(.95); }
.pc-btn.danger { color:#EF4444; border-color:#FCA5A5; background:#FFF5F5; }
.empty-state { text-align:center; padding:60px 20px; color:var(--text3); }
.empty-icon { font-size:40px; display:block; margin-bottom:12px; }
.loading-state { text-align:center; padding:60px; color:var(--text3); font-size:14px; }

/* PREVIEW */
.pv-box { background:#fff; border-radius:var(--radius); margin-bottom:14px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.08); }
.pv-header { background:var(--red); color:#fff; padding:16px 18px; }
.pv-header h2 { font-size:15px; font-weight:700; margin-bottom:2px; }
.pv-body { padding:16px; }
.pv-sec { margin-bottom:14px; }
.pv-sec-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text3); margin-bottom:7px; border-bottom:1px solid var(--border); padding-bottom:5px; }
.pv-row { display:flex; justify-content:space-between; padding:6px 0; font-size:13px; border-bottom:1px solid #F2F2F7; gap:10px; }
.pv-row:last-child { border-bottom:none; }
.pk { color:var(--text2); flex-shrink:0; font-weight:500; }
.pv-val { font-weight:600; text-align:right; word-break:break-word; }
.total-bar { background:#1C1C1E; color:#fff; border-radius:10px; padding:13px 16px; display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
.total-bar .tl { font-size:11px; font-weight:600; opacity:.5; text-transform:uppercase; letter-spacing:.4px; }
.total-bar .tv { font-size:20px; font-weight:800; color:#FF6B6B; }
.pv-actions { display:flex; flex-direction:column; gap:9px; margin-bottom:14px; }
.pv-footer { background:var(--surface2); border-top:1px solid var(--border); padding:9px 16px; display:flex; justify-content:space-between; font-size:11px; color:var(--text3); }

/* TOTAL PREVIEW */
.total-preview { background:#F0FFF4; border:1px solid #BBF7D0; border-radius:10px; padding:13px 15px; display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
.tp-l { font-size:12px; font-weight:700; color:#15803D; }
.tp-v { font-size:20px; font-weight:800; color:#15803D; }

/* AVISO */
.aviso-int { background:#FFFBEB; border:1px solid #FDE68A; border-radius:8px; padding:11px 13px; font-size:12px; color:#92400E; margin-bottom:13px; line-height:1.5; }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:999; display:none; align-items:flex-end; justify-content:center; padding-bottom:var(--safe-bottom); }
.modal-overlay.show { display:flex; }
.modal-box { background:#fff; border-radius:20px 20px 0 0; padding:6px 20px 22px; width:100%; max-width:480px; }
.modal-handle { width:34px; height:4px; background:var(--border); border-radius:2px; margin:10px auto 16px; }
.modal-box h3 { font-size:18px; font-weight:700; margin-bottom:7px; text-align:center; }
.modal-box p { font-size:14px; color:var(--text2); margin-bottom:20px; text-align:center; line-height:1.5; }
.modal-btns { display:flex; flex-direction:column; gap:9px; }

/* TOAST */
.toast { position:fixed; bottom:calc(var(--tab-h) + var(--safe-bottom) + 10px); left:50%; transform:translateX(-50%) translateY(30px); background:#1C1C1E; color:#fff; padding:11px 20px; border-radius:20px; font-size:13px; font-weight:500; opacity:0; transition:all .2s; z-index:9999; white-space:nowrap; pointer-events:none; box-shadow:0 4px 20px rgba(0,0,0,.3); }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* PERFIL */
.profile-saved { background:#F0FFF4; border:1px solid #BBF7D0; border-radius:9px; padding:12px 14px; margin-bottom:13px; font-size:14px; font-weight:600; color:#15803D; }
.logo-area { border:2px dashed var(--border); border-radius:10px; padding:22px; text-align:center; cursor:pointer; background:var(--surface2); position:relative; min-height:80px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:6px; }
.logo-area img { max-height:70px; max-width:180px; object-fit:contain; }
.logo-ph { font-size:13px; color:var(--text3); }
#logoInput { position:absolute; inset:0; opacity:0; cursor:pointer; }

.sec-head { margin-bottom:16px; }
.sec-head h1 { font-size:22px; font-weight:800; margin-bottom:3px; }
.sec-head p { font-size:13px; color:var(--text2); }

.foto-area { border:2px dashed var(--border); border-radius:10px; padding:20px 14px; text-align:center; cursor:pointer; background:var(--surface2); min-height:70px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; }
.foto-area:active { border-color:var(--red); }
.foto-grid { display:flex; flex-wrap:wrap; gap:7px; }
.foto-thumb { width:72px; height:72px; border-radius:9px; object-fit:cover; border:1.5px solid var(--border); }

.subtotal-row { display:flex; justify-content:space-between; align-items:center; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:11px 13px; margin-top:6px; font-size:13px; }
.subtotal-row .sl { color:var(--text2); font-weight:500; }
.subtotal-row .sv { font-weight:700; color:var(--text); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Fifty+</div>
    <div class="login-sub">Propostas profissionais para marceneiros</div>
    <div id="loginForm">
      <label class="login-label">E-mail</label>
      <input class="login-input" type="email" id="loginEmail" placeholder="seu@email.com" autocomplete="email" inputmode="email">
      <label class="login-label">Senha</label>
      <input class="login-input" type="password" id="loginPass" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      <div class="login-err" id="loginErr"></div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()">Entrar</button>
      <div class="login-link" onclick="showForgot()">Esqueci minha senha</div>
    </div>
    <div id="forgotForm" style="display:none">
      <label class="login-label">E-mail cadastrado</label>
      <input class="login-input" type="email" id="forgotEmail" placeholder="seu@email.com" inputmode="email">
      <div class="login-err" id="forgotErr"></div>
      <button class="login-btn" id="forgotBtn" onclick="doForgot()">Enviar link de recuperacao</button>
      <div class="login-link"><a onclick="showLogin()">Voltar ao login</a></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">
  <div class="topbar">
    <div class="topbar-logo">Fifty+</div>
    <div class="topbar-right">
      <div class="nav-avatar" id="navAvatar">?</div>
      <button class="btn-sair" onclick="doLogout()">Sair</button>
    </div>
  </div>

  <div class="content">

    <!-- PROPOSTAS -->
    <div class="page active" id="page-propostas">
      <div class="prop-header">
        <div>
          <h1>Propostas</h1>
          <div style="font-size:12px;color:var(--text3);margin-top:2px;" id="totalPropostas"></div>
        </div>
        <button class="btn-nova" onclick="novaPropostaNav()">+ Nova</button>
      </div>
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Buscar cliente..." oninput="filtrarPropostas()">
        <select id="filterStatus" onchange="filtrarPropostas()">
          <option value="">Todas</option>
          <option value="ativa">Ativas</option>
          <option value="enviada">Enviadas</option>
          <option value="fechada">Fechadas</option>
        </select>
      </div>
      <div id="propostasList"><div class="loading-state">Carregando...</div></div>
    </div>

    <!-- ORCAMENTO -->
    <div class="page" id="page-orcamento">
      <div class="sec-head">
        <h1 id="orcTitle">Nova Proposta</h1>
        <p>Preencha todos os dados da proposta.</p>
      </div>

      <div class="steps-bar">
        <div class="step-dot active" id="sdot1" onclick="goStep(1)"><div class="sd">1</div>Cliente</div>
        <div class="step-line"></div>
        <div class="step-dot" id="sdot2" onclick="goStep(2)"><div class="sd">2</div>Ambientes</div>
        <div class="step-line"></div>
        <div class="step-dot" id="sdot3" onclick="goStep(3)"><div class="sd">3</div>Valores</div>
        <div class="step-line"></div>
        <div class="step-dot" id="sdot4" onclick="goStep(4)"><div class="sd">4</div>Condicoes</div>
      </div>

      <!-- STEP 1 -->
      <div id="step1">
        <div class="card">
          <div class="card-head">Dados do Cliente</div>
          <div class="field"><label>Nome do Cliente</label><input type="text" id="c-nome" placeholder="Nome completo do cliente" autocorrect="off"></div>
          <div class="field"><label>WhatsApp</label><input type="tel" id="c-wpp" placeholder="(98) 99999-9999" inputmode="tel"></div>
          <div class="field"><label>Localizacao do Projeto</label><input type="text" id="c-local" placeholder="Condominio, rua, bairro, cidade..."></div>
          <div class="field"><label>Validade da Proposta</label><input type="text" id="c-validade" placeholder="Ex: 15 dias ou A definir"></div>
        </div>
        <button class="btn btn-primary" onclick="goStep(2)">Proximo: Ambientes</button>
      </div>

      <!-- STEP 2 -->
      <div id="step2" style="display:none">
        <div class="card">
          <div class="card-head">Detalhamento por Ambiente</div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5;">Adicione cada ambiente com seus itens, medidas, acabamento e puxadores exatamente como aparecera no orcamento.</p>
          <div id="ambientesList"></div>
          <button class="btn-add-amb" onclick="addAmbiente()">+ Adicionar Ambiente</button>
        </div>
        <div class="card">
          <div class="card-head">Fotos de Referencia</div>
          <div class="foto-area" id="fotoArea" onclick="document.getElementById('fotosInput').click()">
            <input type="file" id="fotosInput" accept="image/*" multiple style="display:none" onchange="loadFotos(this)">
            <div id="fotoPlaceholder" style="font-size:13px;color:var(--text3);">Toque para adicionar fotos de referencia</div>
            <div id="fotoGrid" class="foto-grid" style="display:none;"></div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-outline" onclick="goStep(1)">Voltar</button>
          <button class="btn btn-primary" onclick="goStep(3)">Proximo: Valores</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div id="step3" style="display:none">
        <div class="card">
          <div class="card-head">Valor por Ambiente</div>
          <p style="font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5;">Informe o valor de cada ambiente. Aparece no sumario de investimento do PDF.</p>
          <div id="valoresAmbList"></div>
        </div>
        <div class="card">
          <div class="card-head">Custos Internos</div>
          <div class="aviso-int">Estes valores sao privados. O cliente ve apenas o valor final da proposta.</div>
          <div class="field"><label>Materiais (R$)</label><input type="number" id="v-mat" placeholder="0,00" min="0" step="0.01" inputmode="decimal" oninput="calcTotal()"></div>
          <div class="field"><label>Mao de Obra (R$)</label><input type="number" id="v-mao" placeholder="0,00" min="0" step="0.01" inputmode="decimal" oninput="calcTotal()"></div>
          <div class="field"><label>Ferragens (R$)</label><input type="number" id="v-ferr" placeholder="0,00" min="0" step="0.01" inputmode="decimal" oninput="calcTotal()"></div>
          <div class="field"><label>Outros (R$)</label><input type="number" id="v-outros" placeholder="0,00" min="0" step="0.01" inputmode="decimal" oninput="calcTotal()"></div>
          <div style="border-top:1px solid var(--border);padding-top:13px;margin-top:4px;">
            <label>Margem de Lucro (%)</label>
            <div style="display:flex;gap:9px;margin-top:7px;align-items:center;">
              <input type="number" id="v-margem" value="30" min="0" step="1" inputmode="numeric" oninput="calcTotal()" style="width:90px;flex:none;">
              <div style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 12px;font-size:13px;color:var(--text3);">
                Lucro: <strong id="v-margem-val" style="color:var(--red);">R$ 0,00</strong>
              </div>
            </div>
          </div>
          <div class="total-preview">
            <span class="tp-l">TOTAL DO CLIENTE</span>
            <span class="tp-v" id="v-total-preview">R$ 0,00</span>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-outline" onclick="goStep(2)">Voltar</button>
          <button class="btn btn-primary" onclick="goStep(4)">Proximo: Condicoes</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div id="step4" style="display:none">
        <div class="card">
          <div class="card-head">Condicoes Comerciais</div>
          <div class="field">
            <label>Primeira Parcela</label>
            <textarea id="pg-parcela1" rows="3" placeholder="Ex: 50% do valor total&#10;Parcelamento em ate 5x sem juros&#10;Parcelamento em ate 12x com juros"></textarea>
          </div>
          <div class="field">
            <label>Segunda Parcela</label>
            <textarea id="pg-parcela2" rows="3" placeholder="Ex: 50% apos a conclusao da instalacao&#10;Parcelamento em ate 5x sem juros&#10;Parcelamento em ate 12x com juros"></textarea>
          </div>
          <div class="field">
            <label>Prazo de Entrega e Instalacao</label>
            <input type="text" id="pg-prazo" placeholder="Ex: ate 60 dias uteis, com possibilidade de antecipacao">
          </div>
          <div class="field">
            <label>Chave PIX</label>
            <input type="text" id="pg-pix" placeholder="CPF, CNPJ, telefone ou e-mail">
          </div>
        </div>
        <div class="card">
          <div class="card-head">Consideracoes Importantes</div>
          <textarea id="pg-consideracoes" rows="4" placeholder="Ex: Esta proposta nao contempla itens como tampos de pedra, cubas, eletrodomesticos, instalacoes eletricas/hidraulicas ou quaisquer outros elementos nao mencionados."></textarea>
        </div>
        <div class="card">
          <div class="card-head">Observacoes Finais</div>
          <textarea id="obs-final" rows="2" placeholder="Ex: Agradecemos a oportunidade de apresentar esta proposta."></textarea>
        </div>
        <div class="btn-row" style="margin-top:4px;">
          <button class="btn btn-outline" onclick="goStep(3)">Voltar</button>
          <button class="btn btn-primary" id="btnSalvar" onclick="salvarProposta()">Salvar Proposta</button>
        </div>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="page" id="page-preview">
      <div class="sec-head"><h1>Proposta</h1><p>Revise, baixe o PDF ou envie pelo WhatsApp.</p></div>
      <div class="pv-box">
        <div class="pv-header">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <div>
              <h2>Proposta de Orcamento</h2>
              <div id="pv-num" style="font-size:12px;opacity:.7;margin-top:2px;"></div>
            </div>
            <div id="pvLogoBox" style="background:#fff;border-radius:8px;padding:6px 10px;display:flex;align-items:center;justify-content:center;min-width:54px;"></div>
          </div>
        </div>
        <div class="pv-body">
          <div class="pv-sec">
            <div class="pv-sec-title">Cliente</div>
            <div class="pv-row"><span class="pk">Nome</span><span class="pv-val" id="pv-c-nome">—</span></div>
            <div class="pv-row"><span class="pk">Localizacao</span><span class="pv-val" id="pv-c-local">—</span></div>
            <div class="pv-row"><span class="pk">Validade</span><span class="pv-val" id="pv-c-validade">—</span></div>
          </div>
          <div class="pv-sec">
            <div class="pv-sec-title">Ambientes</div>
            <div id="pv-amb-body"></div>
          </div>
          <div class="total-bar">
            <div class="tl">Investimento Total</div>
            <div class="tv" id="pv-total">R$ 0,00</div>
          </div>
          <div class="pv-sec" style="margin-top:14px;">
            <div class="pv-sec-title">Condicoes Comerciais</div>
            <div class="pv-row" id="pv-p1-row"><span class="pk">1a Parcela</span><span class="pv-val" id="pv-p1">—</span></div>
            <div class="pv-row" id="pv-p2-row"><span class="pk">2a Parcela</span><span class="pv-val" id="pv-p2">—</span></div>
            <div class="pv-row" id="pv-prazo-row"><span class="pk">Prazo</span><span class="pv-val" id="pv-prazo">—</span></div>
            <div class="pv-row" id="pv-pix-row"><span class="pk">PIX</span><span class="pv-val" id="pv-pix">—</span></div>
          </div>
          <div id="pv-cons-box" style="background:#F8F8F8;border:1px solid var(--border);border-radius:9px;padding:11px 13px;font-size:12px;color:var(--text2);margin-top:6px;display:none;line-height:1.6;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:5px;">Consideracoes Importantes</div>
            <span id="pv-cons"></span>
          </div>
          <div id="pv-obs-box" style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:9px;padding:11px 13px;font-size:13px;color:#78350F;margin-top:8px;display:none;font-style:italic;">
            <span id="pv-obs"></span>
          </div>
        </div>
        <div class="pv-footer">
          <span>Gerado por <strong style="color:var(--red);">Fifty+</strong></span>
          <span id="pv-footer-date">—</span>
        </div>
      </div>
      <div class="pv-actions">
        <button class="btn btn-dark" onclick="gerarPDF(false)">Baixar PDF</button>
        <button class="btn btn-wa" onclick="enviarWhatsApp()">Enviar via WhatsApp</button>
        <button class="btn btn-outline" onclick="showPage('propostas')">Voltar para Propostas</button>
      </div>
    </div>

    <!-- PERFIL -->
    <div class="page" id="page-perfil">
      <div class="sec-head"><h1>Perfil</h1><p>Dados que aparecem em todas as propostas.</p></div>
      <div id="profileSavedMsg" style="display:none;"><div class="profile-saved">Perfil salvo com sucesso!</div></div>
      <div class="card">
        <div class="card-head">Dados da Marcenaria</div>
        <div class="field"><label>Nome da Marcenaria</label><input type="text" id="p-nome" placeholder="Ex: Marcenaria do Joao Silva"></div>
        <div class="field"><label>CPF / CNPJ</label><input type="text" id="p-cpf" placeholder="000.000.000-00" inputmode="numeric"></div>
        <div class="g2">
          <div class="field"><label>WhatsApp</label><input type="tel" id="p-wpp" placeholder="(98) 99999-9999" inputmode="tel"></div>
          <div class="field"><label>WhatsApp 2</label><input type="tel" id="p-wpp2" placeholder="(98) 99999-9999" inputmode="tel"></div>
        </div>
        <div class="field"><label>Cidade / Estado</label><input type="text" id="p-cidade" placeholder="Sao Luis, MA"></div>
        <div class="field"><label>Endereco</label><input type="text" id="p-endereco" placeholder="Rua, numero, bairro..."></div>
        <div class="field"><label>Instagram</label><input type="text" id="p-insta" placeholder="@marcenaria"></div>
        <div class="field"><label>Especialidade</label><input type="text" id="p-esp" placeholder="Ex: Moveis Planejados"></div>
      </div>
      <div class="card">
        <div class="card-head">Logo da Empresa</div>
        <div class="logo-area">
          <input type="file" id="logoInput" accept="image/*" onchange="loadLogo(this)">
          <div id="logoPlaceholder" class="logo-ph">Toque para fazer upload da logo</div>
          <img id="logoPreview" style="display:none">
        </div>
        <div style="font-size:12px;color:var(--text3);margin-top:8px;text-align:center;">A logo aparece no topo das propostas. Use fundo branco para melhor resultado.</div>
      </div>
      <div class="card">
        <div class="card-head">Configuracoes Padrao</div>
        <div class="field"><label>Validade padrao das propostas</label><input type="text" id="p-validade" placeholder="Ex: 15 dias"></div>
        <div class="field"><label>Rodape das propostas</label><textarea id="p-rodape" rows="2" placeholder="Ex: (98) 98509-6913 | @marcenaria | Sao Luis - MA"></textarea></div>
      </div>
      <button class="btn btn-primary" id="btnSalvarPerfil" onclick="salvarPerfil()">Salvar Perfil</button>
    </div>

  </div>

  <!-- TABBAR -->
  <div class="tabbar">
    <button class="tab-btn active" id="tab-propostas" onclick="showPage('propostas')">
      <span class="tab-icon">&#9776;</span>
      <span class="tab-label">Propostas</span>
    </button>
    <button class="tab-btn" id="tab-orcamento" onclick="novaPropostaNav()">
      <span class="tab-icon" style="font-size:26px;font-weight:300;">+</span>
      <span class="tab-label">Nova</span>
    </button>
    <button class="tab-btn" id="tab-perfil" onclick="showPage('perfil')">
      <span class="tab-icon">&#9881;</span>
      <span class="tab-label">Perfil</span>
    </button>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal-overlay" id="modalDelete">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <h3>Excluir proposta?</h3>
    <p>Esta acao nao pode ser desfeita.</p>
    <div class="modal-btns">
      <button class="btn btn-primary" style="background:#EF4444;" onclick="confirmarDelete()">Excluir</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://ibpccilnypuxumsocalc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlicGNjaWxueXB1eHVtc29jYWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTUwODgsImV4cCI6MjA4NzQzMTA4OH0.RJw5ycWb4vbp_csErwWQBuXiSHAFJ1kdvDOw1TUj5Ec';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser=null, currentProfile={}, logoData=null;
let ambientes=[], fotosData=[], allPropostas=[];
let editingId=null, deleteTargetId=null, orcNumBase=1;
let currentPropostaData={}, appReady=false;

// ── AUTH ──
async function doLogin(){
  const email=g('loginEmail').value.trim(), pass=g('loginPass').value;
  if(!email||!pass) return showErr('loginErr','Preencha e-mail e senha.');
  setBtn('loginBtn',true,'Entrando...');
  const {error}=await sb.auth.signInWithPassword({email,password:pass});
  setBtn('loginBtn',false,'Entrar');
  if(error) showErr('loginErr',tradErr(error.message));
}
async function doForgot(){
  const email=g('forgotEmail').value.trim();
  if(!email) return showErr('forgotErr','Digite seu e-mail.');
  setBtn('forgotBtn',true,'Enviando...');
  const {error}=await sb.auth.resetPasswordForEmail(email);
  setBtn('forgotBtn',false,'Enviar link de recuperacao');
  if(error) return showErr('forgotErr',tradErr(error.message));
  showErr('forgotErr','Link enviado! Verifique seu e-mail.',true);
}
async function doLogout(){
  try{await sb.auth.signOut();}catch(e){}
  currentUser=null; appReady=false;
  g('appScreen').style.display='none';
  g('loginScreen').style.display='flex';
}
function showLogin(){g('loginForm').style.display='block';g('forgotForm').style.display='none';}
function showForgot(){g('loginForm').style.display='none';g('forgotForm').style.display='block';}
function tradErr(m){
  if(m.includes('Invalid login')||m.includes('invalid_credentials')) return 'E-mail ou senha incorretos.';
  if(m.includes('Email not confirmed')) return 'Confirme seu e-mail antes de entrar.';
  return m;
}
function showErr(id,msg,ok=false){
  const el=g(id); el.textContent=msg; el.style.display='block';
  el.style.background=ok?'#F0FDF4':'#FFF0F0'; el.style.borderColor=ok?'#BBF7D0':'#FCA5A5'; el.style.color=ok?'#16A34A':'var(--red)';
}
function setBtn(id,dis,txt){const el=g(id);if(el){el.disabled=dis;el.textContent=txt;}}

// ── SESSION ──
sb.auth.onAuthStateChange(async(event,session)=>{
  if(session?.user){
    currentUser=session.user;
    g('navAvatar').textContent=(session.user.email||'U')[0].toUpperCase();
    g('loginScreen').style.display='none';
    g('appScreen').style.display='block';
    if(!appReady){appReady=true;await carregarPerfil();await carregarPropostas();}
  } else {
    currentUser=null; appReady=false;
    g('appScreen').style.display='none';
    g('loginScreen').style.display='flex';
  }
});

// ── NAV ──
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  g('page-'+id)?.classList.add('active');
  ['propostas','orcamento','perfil'].forEach(t=>g('tab-'+t)?.classList.toggle('active',t===id));
  window.scrollTo({top:0,behavior:'smooth'});
}
function novaPropostaNav(){novaPropostaForm();showPage('orcamento');}

// ── PERFIL ──
async function salvarPerfil(){
  if(!currentUser) return;
  const btn=g('btnSalvarPerfil'); btn.disabled=true; btn.textContent='Salvando...';
  const data={id:currentUser.id,nome:v('p-nome'),wpp:v('p-wpp'),wpp2:v('p-wpp2'),cidade:v('p-cidade'),insta:v('p-insta'),especialidade:v('p-esp'),cpf:v('p-cpf'),endereco:v('p-endereco'),validade:v('p-validade'),rodape:v('p-rodape'),logo:logoData,updated_at:new Date().toISOString()};
  const {error}=await sb.from('profiles').upsert(data);
  btn.disabled=false; btn.textContent='Salvar Perfil';
  if(error){toast('Erro: '+error.message);return;}
  currentProfile=data;
  const m=g('profileSavedMsg'); m.style.display='block'; toast('Perfil salvo!');
  setTimeout(()=>m.style.display='none',3000);
}
async function carregarPerfil(){
  if(!currentUser) return;
  const {data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
  if(!data) return; currentProfile=data;
  set('p-nome',data.nome); set('p-wpp',data.wpp); set('p-wpp2',data.wpp2||'');
  set('p-cidade',data.cidade); set('p-insta',data.insta); set('p-esp',data.especialidade);
  set('p-cpf',data.cpf||''); set('p-endereco',data.endereco||''); set('p-validade',data.validade||''); set('p-rodape',data.rodape||'');
  if(data.logo){logoData=data.logo;g('logoPreview').src=data.logo;g('logoPreview').style.display='block';g('logoPlaceholder').style.display='none';}
}
function loadLogo(input){
  const file=input.files[0]; if(!file) return;
  const r=new FileReader(); r.onload=e=>{logoData=e.target.result;g('logoPreview').src=logoData;g('logoPreview').style.display='block';g('logoPlaceholder').style.display='none';}; r.readAsDataURL(file);
}

// ── PROPOSTAS ──
async function carregarPropostas(){
  if(!currentUser) return;
  g('propostasList').innerHTML='<div class="loading-state">Carregando...</div>';
  const {data,error}=await sb.from('propostas').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  if(error){g('propostasList').innerHTML='<div class="loading-state">Erro ao carregar. Tente novamente.</div>';return;}
  allPropostas=data||[]; orcNumBase=allPropostas.length+1; renderPropostas(allPropostas);
}
function renderPropostas(lista){
  const el=g('propostasList');
  g('totalPropostas').textContent=lista.length+' proposta'+(lista.length!==1?'s':'');
  if(!lista.length){el.innerHTML=`<div class="empty-state"><span class="empty-icon">&#9776;</span><p style="font-size:14px;line-height:1.6;">Nenhuma proposta ainda.<br>Toque em <strong>+ Nova</strong> para comecar.</p></div>`;return;}
  el.innerHTML=lista.map(p=>{
    const num=String(p.numero||1).padStart(3,'0'), dt=new Date(p.created_at).toLocaleDateString('pt-BR'), st=p.status||'ativa';
    const ambs=(p.ambientes||[]).map(a=>a.nome).filter(Boolean).join(', ')||'—';
    return `<div class="prop-card">
      <div class="pc-top">
        <div>
          <div class="pc-num">#${num} &middot; ${dt}</div>
          <div class="pc-cliente">${esc(p.cliente_nome||'Cliente nao informado')}</div>
          <div class="pc-tipo">${esc(ambs)}</div>
          <span class="status-badge status-${st}">${st}</span>
        </div>
        <div class="pc-total">${fmt(p.v_total||0)}</div>
      </div>
      <div class="pc-actions">
        <button class="pc-btn" onclick="visualizarProposta('${p.id}')">Ver</button>
        <button class="pc-btn" onclick="editarProposta('${p.id}')">Editar</button>
        <button class="pc-btn" onclick="reenviarWA('${p.id}')">WhatsApp</button>
        <button class="pc-btn danger" onclick="deletarProposta('${p.id}')">Excluir</button>
      </div>
    </div>`;
  }).join('');
}
function filtrarPropostas(){
  const q=g('searchInput').value.toLowerCase(), st=g('filterStatus').value;
  renderPropostas(allPropostas.filter(p=>(!q||(p.cliente_nome||'').toLowerCase().includes(q))&&(!st||p.status===st)));
}

// ── SALVAR ──
async function salvarProposta(){
  if(!currentUser){toast('Faca login novamente.');return;}
  const btn=g('btnSalvar'); btn.disabled=true; btn.textContent='Salvando...';
  try {
    const mat=parseFloat(v('v-mat'))||0, mao=parseFloat(v('v-mao'))||0, ferr=parseFloat(v('v-ferr'))||0, out=parseFloat(v('v-outros'))||0, marg=parseFloat(v('v-margem'))||0;
    const sub=mat+mao+ferr+out, total=sub*(1+marg/100);
    const ambData=ambientes.map(id=>({
      nome:v('an-'+id), itens:v('ai-'+id), medidas:v('am-'+id),
      acabamento:v('aa-'+id), puxadores:v('ap-'+id), observacoes:v('ao-'+id),
      valor:parseFloat(v('av-'+id))||0
    })).filter(a=>a.nome);
    const payload={
      user_id:currentUser.id, numero:editingId?undefined:orcNumBase,
      cliente_nome:v('c-nome'), cliente_wpp:v('c-wpp'), cliente_local:v('c-local'), cliente_validade:v('c-validade'),
      ambientes:ambData, fotos:fotosData,
      v_mat:mat, v_mao:mao, v_ferr:ferr, v_outros:out, v_margem:marg, v_total:total,
      pg_parcela1:v('pg-parcela1'), pg_parcela2:v('pg-parcela2'), pg_prazo:v('pg-prazo'), pg_pix:v('pg-pix'),
      pg_consideracoes:v('pg-consideracoes'), obs_final:v('obs-final'),
      status:'ativa', updated_at:new Date().toISOString()
    };
    let error;
    if(editingId){({error}=await sb.from('propostas').update(payload).eq('id',editingId));}
    else{({error}=await sb.from('propostas').insert(payload));}
    if(error) throw new Error(error.message);
    toast(editingId?'Proposta atualizada!':'Proposta salva!');
    await carregarPropostas();
    const salva=editingId?allPropostas.find(x=>x.id===editingId):allPropostas[0];
    if(salva){currentPropostaData=salva;montarPreviewDeProposta(salva);}
    else montarPreview();
    editingId=null; showPage('preview');
  } catch(err){toast('Erro: '+(err.message||'Tente novamente.'));}
  finally{btn.disabled=false;btn.textContent='Salvar Proposta';}
}

// ── VER / EDITAR / DELETAR ──
function visualizarProposta(id){const p=allPropostas.find(x=>x.id===id);if(!p)return;currentPropostaData=p;montarPreviewDeProposta(p);showPage('preview');}
function editarProposta(id){
  const p=allPropostas.find(x=>x.id===id);if(!p)return;
  editingId=id;
  document.getElementById('orcTitle').textContent='Editar Proposta';
  document.getElementById('btnSalvar').textContent='Salvar Alteracoes';
  set('c-nome',p.cliente_nome);set('c-wpp',p.cliente_wpp);set('c-local',p.cliente_local||'');set('c-validade',p.cliente_validade||'');
  ambientes=[];g('ambientesList').innerHTML='';g('valoresAmbList').innerHTML='';
  (p.ambientes||[]).forEach(a=>addAmbiente(a));
  fotosData=p.fotos||[];renderFotoGrid();
  set('v-mat',p.v_mat||'');set('v-mao',p.v_mao||'');set('v-ferr',p.v_ferr||'');set('v-outros',p.v_outros||'');set('v-margem',p.v_margem??30);
  set('pg-parcela1',p.pg_parcela1||'');set('pg-parcela2',p.pg_parcela2||'');set('pg-prazo',p.pg_prazo||'');set('pg-pix',p.pg_pix||'');
  set('pg-consideracoes',p.pg_consideracoes||'');set('obs-final',p.obs_final||'');
  calcTotal();goStep(1);showPage('orcamento');
}
function deletarProposta(id){deleteTargetId=id;g('modalDelete').classList.add('show');}
async function confirmarDelete(){
  if(!deleteTargetId) return;
  await sb.from('propostas').delete().eq('id',deleteTargetId);
  closeModal();toast('Proposta excluida.');deleteTargetId=null;await carregarPropostas();
}
function closeModal(){g('modalDelete').classList.remove('show');deleteTargetId=null;}
g('modalDelete').addEventListener('click',function(e){if(e.target===this)closeModal();});

// ── AMBIENTES ──
function addAmbiente(data={}){
  const id=Date.now()+Math.random(); ambientes.push(id);
  const idx=ambientes.length;
  const div=document.createElement('div');div.className='amb-item';div.id='amb-'+id;
  div.innerHTML=`
    <div class="amb-header">
      <span class="amb-num">Ambiente ${idx}</span>
      <button class="btn-rm" onclick="removeAmbiente('${id}')">&times;</button>
    </div>
    <div class="field"><label>Nome do Ambiente</label><input type="text" id="an-${id}" placeholder="Ex: Cozinha, Quarto, Escritorio, Closet..." value="${esc(data.nome||'')}"></div>
    <div class="field"><label>Itens</label><textarea id="ai-${id}" rows="2" placeholder="Ex: Bancada com 4 gavetas e nicho, prateleiras...">${esc(data.itens||'')}</textarea></div>
    <div class="field"><label>Medidas</label><textarea id="am-${id}" rows="3" placeholder="Ex: Guarda-roupa: 2,55m Altura x 2,30m Largura x 0,60m Profundidade&#10;Bancada: 0,75m A x 0,80m L x 0,40m P">${esc(data.medidas||'')}</textarea></div>
    <div class="field"><label>Acabamento</label><textarea id="aa-${id}" rows="2" placeholder="Ex: Parte interna em MDF Branco TX, portas em Amadeirado, parte externa em Cinza Fendi">${esc(data.acabamento||'')}</textarea></div>
    <div class="field"><label>Puxadores</label><input type="text" id="ap-${id}" placeholder="Ex: Modelo Gola na cor preta" value="${esc(data.puxadores||'')}"></div>
    <div class="field"><label>Detalhes / Observacoes</label><input type="text" id="ao-${id}" placeholder="Ex: Tampo de vidro sobreposto" value="${esc(data.observacoes||'')}"></div>`;
  g('ambientesList').appendChild(div);
  // Valor
  const vdiv=document.createElement('div');vdiv.className='field';vdiv.id='vamb-'+id;
  vdiv.innerHTML=`<label id="vlabel-${id}">Ambiente ${idx}${data.nome?' – '+data.nome:''}</label><input type="number" id="av-${id}" placeholder="0,00" value="${data.valor||''}" min="0" step="0.01" inputmode="decimal" oninput="calcTotal()">`;
  g('valoresAmbList').appendChild(vdiv);
}
function removeAmbiente(id){
  g('amb-'+id)?.remove();g('vamb-'+id)?.remove();
  ambientes=ambientes.filter(x=>x!=id);calcTotal();
}

// ── FOTOS ──
function loadFotos(input){[...input.files].forEach(file=>{const r=new FileReader();r.onload=e=>{fotosData.push(e.target.result);renderFotoGrid();};r.readAsDataURL(file);});}
function renderFotoGrid(){
  const grid=g('fotoGrid'),ph=g('fotoPlaceholder');
  if(fotosData.length>0){ph.style.display='none';grid.style.display='flex';grid.innerHTML=fotosData.map((src,i)=>`<img src="${src}" class="foto-thumb" onclick="removeFoto(${i})">`).join('');}
  else{ph.style.display='block';grid.style.display='none';}
}
function removeFoto(idx){fotosData.splice(idx,1);renderFotoGrid();}

// ── PREVIEW ──
function montarPreview(){
  const ambData=ambientes.map(id=>({nome:v('an-'+id),itens:v('ai-'+id),medidas:v('am-'+id),acabamento:v('aa-'+id),puxadores:v('ap-'+id),observacoes:v('ao-'+id),valor:parseFloat(v('av-'+id))||0})).filter(a=>a.nome);
  const mat=parseFloat(v('v-mat'))||0,mao=parseFloat(v('v-mao'))||0,ferr=parseFloat(v('v-ferr'))||0,out=parseFloat(v('v-outros'))||0,marg=parseFloat(v('v-margem'))||0;
  const total=(mat+mao+ferr+out)*(1+marg/100);
  const p={cliente_nome:v('c-nome'),cliente_wpp:v('c-wpp'),cliente_local:v('c-local'),cliente_validade:v('c-validade'),ambientes:ambData,v_total:total,pg_parcela1:v('pg-parcela1'),pg_parcela2:v('pg-parcela2'),pg_prazo:v('pg-prazo'),pg_pix:v('pg-pix'),pg_consideracoes:v('pg-consideracoes'),obs_final:v('obs-final'),numero:orcNumBase,created_at:new Date().toISOString()};
  currentPropostaData=p;montarPreviewDeProposta(p);
}
function montarPreviewDeProposta(p){
  const hoje=new Date(p.created_at||Date.now()).toLocaleDateString('pt-BR');
  s2('pv-num','N '+String(p.numero||1).padStart(3,'0')+' · '+hoje);
  s2('pv-footer-date','Emitido em '+hoje);
  const logo=logoData||currentProfile.logo;
  g('pvLogoBox').innerHTML=logo?`<img src="${logo}" style="max-height:24px;max-width:70px;object-fit:contain;">`:`<span style="font-size:10px;font-weight:700;color:var(--red);">${currentProfile.nome||''}</span>`;
  s2('pv-c-nome',p.cliente_nome||'—');s2('pv-c-local',p.cliente_local||'—');s2('pv-c-validade',p.cliente_validade||'—');
  const body=g('pv-amb-body');body.innerHTML='';
  (p.ambientes||[]).forEach(a=>{body.innerHTML+=`<div style="background:var(--surface2);border-radius:8px;padding:10px 12px;margin-bottom:7px;font-size:13px;line-height:1.5;"><div style="display:flex;justify-content:space-between;gap:8px;"><strong>${esc(a.nome)}</strong>${a.valor?'<span style="font-weight:700;color:var(--red);flex-shrink:0;">'+fmt(a.valor)+'</span>':''}</div>${a.itens||a.medidas?'<div style="color:var(--text2);margin-top:3px;font-size:12px;">'+(a.itens?a.itens:'')+(a.medidas?'<br>'+a.medidas:'')+'</div>':''}</div>`;});
  s2('pv-total',fmt(p.v_total||0));
  s2('pv-p1',p.pg_parcela1||'—');tog('pv-p1-row',true);
  s2('pv-p2',p.pg_parcela2||'—');tog('pv-p2-row',true);
  s2('pv-prazo',p.pg_prazo||'—');tog('pv-prazo-row',true);
  s2('pv-pix',p.pg_pix||'—');tog('pv-pix-row',true);
  const cb=g('pv-cons-box');if(p.pg_consideracoes){s2('pv-cons',p.pg_consideracoes);cb.style.display='block';}else cb.style.display='none';
  const ob=g('pv-obs-box');if(p.obs_final){s2('pv-obs',p.obs_final);ob.style.display='block';}else ob.style.display='none';
}

// ── WHATSAPP ──
function enviarWhatsApp(){
  const p=currentPropostaData;
  gerarPDF(true);
  const wpp=(v('c-wpp')||p.cliente_wpp||'').replace(/\D/g,'');
  const nome=p.cliente_nome||'';
  const msg=`Ola${nome?' '+nome:''}!\n\nSegue sua proposta de orcamento em PDF em anexo.\n\nQualquer duvida estou a disposicao!\n\n${currentProfile.nome||''}${currentProfile.wpp?'\n'+currentProfile.wpp:''}${currentProfile.wpp2?'\n'+currentProfile.wpp2:''}`;
  const url=wpp?`https://wa.me/55${wpp}?text=${encodeURIComponent(msg)}`:`https://wa.me/?text=${encodeURIComponent(msg)}`;
  setTimeout(()=>window.open(url,'_blank'),1000);
  if(p.id) sb.from('propostas').update({status:'enviada',updated_at:new Date().toISOString()}).eq('id',p.id).then(()=>carregarPropostas());
}
function reenviarWA(id){const p=allPropostas.find(x=>x.id===id);if(!p)return;currentPropostaData=p;montarPreviewDeProposta(p);enviarWhatsApp();}

// ── PDF ── IDENTICO AO MODELO KAPRIZZO
function gerarPDF(silencioso=false){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});
  const p=currentPropostaData;
  const W=210,M=20,TW=W-M*2;
  let y=20;
  const PRETO=[0,0,0], CINZA=[90,90,90], LGREY=[200,200,200], XLGREY=[247,247,247], BRANCO=[255,255,255];

  // LOGO / NOME DA EMPRESA
  const logo=logoData||currentProfile.logo;
  if(logo){
    try{
      // Logo centralizada, arredondada como no modelo
      const lw=36,lh=36;
      doc.addImage(logo,'JPEG',W/2-lw/2,y,lw,lh,'','FAST');
      y+=lh+8;
    }catch(e){
      escreveNomeEmpresa(doc,W,y,PRETO,BRANCO);y+=44;
    }
  } else {
    escreveNomeEmpresa(doc,W,y,PRETO,BRANCO);y+=44;
  }

  // TITULO
  y+=4;
  doc.setFontSize(20);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
  const titulo='PROPOSTA DE ORCAMENTO PARA MOVEIS\nPLANEJADOS';
  const tLines=doc.splitTextToSize(titulo,TW);
  doc.text(tLines,M,y);
  y+=tLines.length*9+5;

  // LINHA DIVISORIA
  doc.setDrawColor(...LGREY);doc.setLineWidth(0.5);doc.line(M,y,W-M,y);y+=10;

  // DADOS DO CLIENTE
  const campos=[['Cliente',p.cliente_nome||'—'],['Localizacao do Projeto',p.cliente_local||'—'],['Validade da Proposta',p.cliente_validade||'—']];
  campos.forEach(([label,valor])=>{
    doc.setFontSize(10);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    const lw2=doc.getTextWidth(label+': ');
    doc.text(label+': ',M,y);
    doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
    const vLines=doc.splitTextToSize(valor,TW-lw2);
    doc.text(vLines,M+lw2,y);
    y+=vLines.length*5.5+0.5;
  });
  y+=10;

  // DETALHAMENTO POR AMBIENTE
  const ambs=p.ambientes||[];
  if(ambs.length>0){
    doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    doc.text('DETALHAMENTO POR AMBIENTE',M,y);y+=4;
    doc.setDrawColor(...LGREY);doc.setLineWidth(0.3);doc.line(M,y,W-M,y);y+=8;

    ambs.forEach((amb,idx)=>{
      if(y>250){doc.addPage();y=20;}
      // Nome ambiente
      doc.setFontSize(11);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
      doc.text((idx+1)+'. '+amb.nome,M,y);y+=6;
      // Itens
      if(amb.itens){
        doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
        const il=doc.splitTextToSize('Itens: '+amb.itens,TW);doc.text(il,M,y);y+=il.length*5;
      }
      // Medidas
      if(amb.medidas){
        doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
        const ml=doc.splitTextToSize('Medidas: '+amb.medidas,TW);doc.text(ml,M,y);y+=ml.length*5;
      }
      // Acabamento
      if(amb.acabamento){
        doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
        const al=doc.splitTextToSize('Acabamento: '+amb.acabamento,TW);doc.text(al,M,y);y+=al.length*5;
      }
      // Puxadores
      if(amb.puxadores){
        doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
        doc.text('Puxadores: '+amb.puxadores,M,y);y+=5;
      }
      // Detalhes
      if(amb.observacoes){
        doc.setFontSize(9.5);doc.setFont('helvetica','italic');doc.setTextColor(130,130,130);
        doc.text('Detalhe: '+amb.observacoes,M,y);y+=5;
      }
      // Subtotal
      if(amb.valor){
        doc.setFontSize(9.5);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
        doc.text('Subtotal '+amb.nome+': '+fmt(amb.valor),M,y);y+=5;
      }
      y+=5;
    });
  }

  // SUMARIO DE INVESTIMENTO
  if(y>230){doc.addPage();y=20;}
  doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
  doc.text('SUMARIO DE INVESTIMENTO',M,y);y+=4;
  doc.setDrawColor(...LGREY);doc.setLineWidth(0.3);doc.line(M,y,W-M,y);y+=6;

  if(ambs.length>0){
    // Header tabela
    doc.setFillColor(240,240,240);doc.rect(M,y,TW,7,'F');
    doc.setFontSize(9);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    doc.text('Ambiente',M+3,y+4.8);
    doc.text('Valor Total',W-M-3,y+4.8,{align:'right'});
    y+=7;
    ambs.forEach((amb,idx)=>{
      if(idx%2===0){doc.setFillColor(...XLGREY);doc.rect(M,y,TW,7,'F');}
      doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...PRETO);
      doc.text(amb.nome||'—',M+3,y+4.8);
      doc.setFont('helvetica','bold');
      doc.text(fmt(amb.valor||0),W-M-3,y+4.8,{align:'right'});
      y+=7;
    });
    y+=3;
  }
  // Total
  doc.setFillColor(...PRETO);doc.rect(M,y,TW,10,'F');
  doc.setFontSize(10);doc.setFont('helvetica','bold');doc.setTextColor(...BRANCO);
  doc.text('INVESTIMENTO TOTAL:',M+4,y+6.8);
  doc.text(fmt(p.v_total||0),W-M-4,y+6.8,{align:'right'});
  y+=16;

  // CONDICOES COMERCIAIS
  const temCond=p.pg_parcela1||p.pg_parcela2||p.pg_prazo;
  if(temCond){
    if(y>230){doc.addPage();y=20;}
    doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    doc.text('CONDICOES COMERCIAIS',M,y);y+=4;
    doc.setDrawColor(...LGREY);doc.line(M,y,W-M,y);y+=8;
    if(p.pg_parcela1){
      doc.setFontSize(9.5);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
      doc.text('Primeira Parcela (50% do valor total):',M,y);y+=5.5;
      doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
      const l1=doc.splitTextToSize(p.pg_parcela1,TW);doc.text(l1,M,y);y+=l1.length*5+4;
    }
    if(p.pg_parcela2){
      doc.setFontSize(9.5);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
      doc.text('Segunda Parcela (50% restante):',M,y);y+=5.5;
      doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
      const l2=doc.splitTextToSize(p.pg_parcela2,TW);doc.text(l2,M,y);y+=l2.length*5+4;
    }
    if(p.pg_prazo){
      doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
      const lp=doc.splitTextToSize('Prazo estimado para entrega e instalacao: '+p.pg_prazo,TW);doc.text(lp,M,y);y+=lp.length*5+4;
    }
    if(p.pg_pix){
      doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
      doc.text('PIX: '+p.pg_pix,M,y);y+=7;
    }
    y+=4;
  }

  // INFORMACOES DE CONTATO
  const temContato=currentProfile.nome||currentProfile.wpp||currentProfile.wpp2;
  if(temContato){
    if(y>240){doc.addPage();y=20;}
    doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    doc.text('INFORMACOES DE CONTATO',M,y);y+=4;
    doc.setDrawColor(...LGREY);doc.line(M,y,W-M,y);y+=7;
    if(currentProfile.nome){doc.setFontSize(10);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);doc.text((currentProfile.especialidade?currentProfile.nome.toUpperCase()+'\n'+currentProfile.especialidade.toUpperCase():currentProfile.nome.toUpperCase()),M,y);y+=currentProfile.especialidade?10:5;}
    const tels=[currentProfile.wpp,currentProfile.wpp2].filter(Boolean).join(' | ');
    if(tels){doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);doc.text('Telefones: '+tels,M,y);y+=6;}
    y+=4;
  }

  // CONSIDERACOES IMPORTANTES
  if(p.pg_consideracoes){
    if(y>230){doc.addPage();y=20;}
    doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(...PRETO);
    doc.text('CONSIDERACOES IMPORTANTES',M,y);y+=4;
    doc.setDrawColor(...LGREY);doc.line(M,y,W-M,y);y+=7;
    doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...CINZA);
    const cl=doc.splitTextToSize(p.pg_consideracoes,TW);doc.text(cl,M,y);y+=cl.length*5+6;
  }

  // OBS FINAL / AGRADECIMENTO
  if(p.obs_final){
    if(y>260){doc.addPage();y=20;}
    doc.setFontSize(9.5);doc.setFont('helvetica','italic');doc.setTextColor(...CINZA);
    const ol=doc.splitTextToSize(p.obs_final,TW);doc.text(ol,M,y);y+=ol.length*5+4;
  }

  // RODAPE
  if(currentProfile.rodape){
    if(y>265){doc.addPage();y=20;}
    doc.setFontSize(8.5);doc.setFont('helvetica','normal');doc.setTextColor(160,160,160);
    const rl=doc.splitTextToSize(currentProfile.rodape,TW);doc.text(rl,M,y);
  }

  // NUMERO DE PAGINAS
  const pages=doc.internal.getNumberOfPages();
  for(let i=1;i<=pages;i++){
    doc.setPage(i);
    doc.setFontSize(7.5);doc.setFont('helvetica','normal');doc.setTextColor(180,180,180);
    doc.text('Pagina '+i+' de '+pages,W-M,290,{align:'right'});
  }

  const nome=(p.cliente_nome||'Proposta').replace(/\s/g,'_');
  const hoje=new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  doc.save('Proposta_'+nome+'_'+hoje+'.pdf');
  if(!silencioso) toast('PDF baixado!');
}

function escreveNomeEmpresa(doc,W,y,PRETO,BRANCO){
  const nm=currentProfile.nome||'MARCENARIA';
  const esp=currentProfile.especialidade||'MOVEIS PLANEJADOS';
  doc.setFillColor(0,0,0);doc.circle(W/2,y+16,18,'F');
  doc.setFontSize(8.5);doc.setFont('helvetica','bold');doc.setTextColor(255,255,255);
  const nml=doc.splitTextToSize(nm.toUpperCase(),28);
  nml.forEach((l,i)=>doc.text(l,W/2,y+10+(i*5.5),{align:'center'}));
  doc.setFontSize(5.5);doc.text(esp.toUpperCase(),W/2,y+10+nml.length*5.5,{align:'center'});
}

// ── FORM HELPERS ──
function goStep(n){
  for(let i=1;i<=4;i++) g('step'+i).style.display=i===n?'block':'none';
  for(let i=1;i<=4;i++){
    const d=g('sdot'+i); d.classList.remove('active','done');
    if(i===n) d.classList.add('active');
    if(i<n) d.classList.add('done');
  }
  if(n===3) sincValores();
  window.scrollTo({top:0,behavior:'smooth'});
}
function sincValores(){
  ambientes.forEach((id,idx)=>{
    const nomeEl=g('an-'+id),lEl=g('vlabel-'+id);
    if(lEl&&nomeEl) lEl.textContent='Ambiente '+(idx+1)+(nomeEl.value?' – '+nomeEl.value:'');
  });
}
function calcTotal(){
  const mat=parseFloat(g('v-mat')?.value)||0,mao=parseFloat(g('v-mao')?.value)||0,ferr=parseFloat(g('v-ferr')?.value)||0,out=parseFloat(g('v-outros')?.value)||0,marg=parseFloat(g('v-margem')?.value)||0;
  const sub=mat+mao+ferr+out,vm=sub*marg/100,total=sub+vm;
  const mv=g('v-margem-val');if(mv)mv.textContent=fmt(vm);
  const tp=g('v-total-preview');if(tp)tp.textContent=fmt(total);
}
function novaPropostaForm(){
  editingId=null;
  g('orcTitle').textContent='Nova Proposta';
  g('btnSalvar').textContent='Salvar Proposta';
  ['c-nome','c-wpp','c-local','c-validade','v-mat','v-mao','v-ferr','v-outros','pg-parcela1','pg-parcela2','pg-prazo','pg-pix','pg-consideracoes','obs-final'].forEach(id=>set(id,''));
  set('v-margem','30');ambientes=[];fotosData=[];
  g('ambientesList').innerHTML='';g('valoresAmbList').innerHTML='';
  renderFotoGrid();calcTotal();goStep(1);
}

// ── UTILS ──
function g(id){return document.getElementById(id);}
function v(id){return g(id)?.value||'';}
function set(id,val){const el=g(id);if(el)el.value=val??'';}
function s2(id,val){const el=g(id);if(el)el.textContent=val||'';}
function tog(id,show){const el=g(id);if(el)el.style.display=show?'':'none';}
function fmt(val){return 'R$ '+(val||0).toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');}
function esc(str){return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg){const t=g('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
</script>
</body>
</html>
